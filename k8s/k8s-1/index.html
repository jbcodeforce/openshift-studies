<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../k8s-0/ rel=prev><link href=../k8s-2/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.6"><title>Networking - Kubernetes Studies</title><link rel=stylesheet href=../../assets/stylesheets/main.558e4712.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary data-md-color-accent> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#networking class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Kubernetes Studies" class="md-header__button md-logo" aria-label="Kubernetes Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Kubernetes Studies </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Networking </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/openshift-studies title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Kubernetes Studies" class="md-nav__button md-logo" aria-label="Kubernetes Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Kubernetes Studies </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/openshift-studies title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 tabindex=0 aria-expanded=true> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../k8s-0/ class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Networking <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Networking </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#docker-networking class=md-nav__link> Docker networking </a> </li> <li class=md-nav__item> <a href=#kubernetes-networking class=md-nav__link> Kubernetes networking </a> <nav class=md-nav aria-label="Kubernetes networking"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#services class=md-nav__link> Services </a> </li> <li class=md-nav__item> <a href=#ingress class=md-nav__link> Ingress </a> </li> <li class=md-nav__item> <a href=#service-discovery class=md-nav__link> Service Discovery </a> </li> <li class=md-nav__item> <a href=#kubernetes-dns class=md-nav__link> Kubernetes DNS </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#virtual-private-cloud class=md-nav__link> Virtual Private Cloud </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../k8s-2/ class=md-nav__link> Security </a> </li> <li class=md-nav__item> <a href=../k8s-3/ class=md-nav__link> Demo it </a> </li> <li class=md-nav__item> <a href=../k8s-faq/ class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=../k8s-comp/ class=md-nav__link> Compendium </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 tabindex=0 aria-expanded=false> Openshift <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Openshift data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Openshift </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ocp/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../os-cn-dev/ class=md-nav__link> Cloud Native Development </a> </li> <li class=md-nav__item> <a href=../../ocp/cp4i/ class=md-nav__link> Cloud Pak Integration </a> </li> <li class=md-nav__item> <a href=../../ocp/faq/ class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=../../ocp/oc-cli/ class=md-nav__link> oc CLI </a> </li> <li class=md-nav__item> <a href=../../deployment-ex/ class=md-nav__link> Deployment examples </a> </li> <li class=md-nav__item> <a href=../../ocp/notes-ocp-training/ class=md-nav__link> Notes from certification </a> </li> <li class=md-nav__item> <a href=../../spark-on-os/ class=md-nav__link> Operators (with Spark) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 tabindex=0 aria-expanded=false> Operations <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Operations data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Operations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../sre/ class=md-nav__link> SRE </a> </li> <li class=md-nav__item> <a href=../../ansible/ class=md-nav__link> Ansible </a> </li> <li class=md-nav__item> <a href=../../spark-on-os/ class=md-nav__link> Operators (with Spark) </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../compendium/ class=md-nav__link> Compendium </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io class=md-nav__link> Return to main </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#docker-networking class=md-nav__link> Docker networking </a> </li> <li class=md-nav__item> <a href=#kubernetes-networking class=md-nav__link> Kubernetes networking </a> <nav class=md-nav aria-label="Kubernetes networking"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#services class=md-nav__link> Services </a> </li> <li class=md-nav__item> <a href=#ingress class=md-nav__link> Ingress </a> </li> <li class=md-nav__item> <a href=#service-discovery class=md-nav__link> Service Discovery </a> </li> <li class=md-nav__item> <a href=#kubernetes-dns class=md-nav__link> Kubernetes DNS </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#virtual-private-cloud class=md-nav__link> Virtual Private Cloud </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=networking>Networking<a class=headerlink href=#networking title="Permanent link">&para;</a></h1> <p>The Cloud Native Computing Foundation (CNCF) sponsors the Container Networking Interface (CNI) open source project which aims to standardize the network interface for containers in cloud native environments, such as Kubernetes.</p> <p>Docker uses the <a href=https://github.com/containernetworking/cni>CNI project</a> to implement a software-defined network (SDN) for containers on each host.</p> <h2 id=docker-networking>Docker networking<a class=headerlink href=#docker-networking title="Permanent link">&para;</a></h2> <p>With <a href=https://docs.docker.com/network/ >Docker there are different networking</a> modes: <code>bridge, host, container or no networking</code>. With <code>bridge</code> mode docker daemon creates a <code>docker0</code> virtual ethernet bridge to forward packets to any interface attached to it. All containers running on the host are attached to this bridge network. Peer attached to the container <code>eth0</code> interface got an IP address and are part of the same subnet. The default bridge network is present on all Docker hosts. If you do not specify a different network, new containers are automatically connected to the default bridge network. The following diagram illustrates those concept for two containers running on your laptop as a host:</p> <p><img alt src=../images/docker-network.png> </p> <p>The following commands are used to understand the diagrams:</p> <div class=highlight><pre><span></span><code><span class=c1># Create a network</span>
docker<span class=w> </span>network<span class=w> </span>create<span class=w> </span>--driver<span class=w> </span>bridge<span class=w> </span>alpine-net
docker<span class=w> </span>run<span class=w> </span>-dit<span class=w> </span>--name<span class=w> </span>alpine1<span class=w> </span>--network<span class=w> </span>alpine-net<span class=w> </span>-p<span class=w> </span><span class=m>8081</span>:8080<span class=w> </span>app1<span class=w> </span>ash
docker<span class=w> </span>run<span class=w> </span>-dit<span class=w> </span>--name<span class=w> </span>alpine2<span class=w> </span>--network<span class=w> </span>alpine-net<span class=w> </span>-p<span class=w> </span><span class=m>8082</span>:8080<span class=w> </span>app2<span class=w> </span>ash
docker<span class=w> </span>network<span class=w> </span>list
docker<span class=w> </span>network<span class=w> </span>inspect<span class=w> </span>alpine-net
<span class=c1># in one of the container</span>
ip<span class=w> </span>addr<span class=w> </span>show
</code></pre></div> <p>Containers are isolated from the host network. Docker containers can talk to other containers only if they are on the same machine. Because of network isolation, a container in one SDN can have the same IP address as a container in a different SDN.</p> <p>With <code>Host</code> mode (<code>docker run -d --net=host yourimagehere</code>) the containers share IP and namespace, and you need to take care of the port numbering schema. There is no routing overhead, but this approach exposes the container to the public network. </p> <p>Docker does not support automatic service discovery on the default bridge network. If you want containers to be able to resolve IP addresses by container name, you should use user-defined networks instead.</p> <p>Exposing ports in a Dockerfile is a way of documenting which ports are used, but does not actually map or open any ports. When starting the container the exposed port is published to a port accessible by others. So for the previous figure, we have:</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>docker<span class=w> </span>run<span class=w> </span>–d<span class=w>  </span>-p<span class=w> </span><span class=m>8081</span>:8080<span class=w> </span>imagename
</code></pre></div> <h2 id=kubernetes-networking>Kubernetes networking<a class=headerlink href=#kubernetes-networking title="Permanent link">&para;</a></h2> <p>Kubernetes uses the <code>container mode</code>, where other containers share the same IP address as a previously created containers within the pod: it is set at the pod scope level. It requires each pod to have an IP in a flat networking namespace with full connectivity to other nodes and pods across the network.</p> <p>The Pod IP address is allocated by Calico IPAM and the networking interface definition within the pod and host is done by Calico CNI plugin. The following diagram illustrates the process:</p> <p><img alt src=../images/cni-pod-net.png></p> <p>The following commands help to see these IP schema:</p> <div class=highlight><pre><span></span><code>$ kubectl get node -o wide
NAME           STATUS  VERSION          EXTERNAL-IP  OS-IMAGE             KERNEL-VERSION      
172.16.40.137  Ready   v1.10.0+icp-ee   &lt;none&gt;       Ubuntu 16.04.3 LTS   4.4.0-112-generic   
172.16.40.139  Ready   v1.10.0+icp-ee   &lt;none&gt;       Ubuntu 16.04.3 LTS   4.4.0-112-generic  
# The 172.16.40.137 is the IP address of the HOST
$ kubectl describe node 172.16.40.137
# but ssh to the host/node and looking at the interface, we can see the ethernet and docker interfaces:
$ ifconfig
ens160    Link encap:Ethernet  HWaddr 00:50:56:a5:cf:34  
          inet addr:172.16.40.137  Bcast:172.16.255.255  Mask:255.255.0.0

docker0   Link encap:Ethernet  HWaddr 02:42:73:1c:72:ca  
           inet addr:172.17.0.1  Bcast:172.17.255.255  Mask:255.255.0.0
</code></pre></div> <p>This IP-per-pod model yields a backward-compatible way for you to treat a pod almost identically to a VM or a physical host, in the context of naming, service discovery, or port allocations. Containers inside a pod can communicate with each other using <code>localhost</code>. </p> <p>Kubernetes uses Calico as Container Network Interface, and is configured with a large flat subnet (e.g. 172.30.0.0/16) for all internal application traffic inside of the cluster. Each worker node in the Kubernetes cluster is assigned one or more non-overlapping slices of this network, coordinated by the Kubernetes master node. When a container is created in the cluster, it gets assigned to a worker node and is given an IP address from the slice of the subnet for the worker node.</p> <p><img alt src=../images/net-pod-host.png></p> <p><strong>Kube-proxy</strong> intercepts and controls where to forward the traffic, internal to the node, or to another worker node running the destination pod, or outside of the cluster. </p> <p>For inter-pod networking as pod has its own routable IP address there is no need for proxies or NAT. Except that with Kubernetes, services use a completely separate set of IP addresses. The IP addresses are not known by Calico, and are not directly routable. However, they are still reachable by pods since the kube-proxy performs NAT on those IPs (NAT from svc IP@ to Pod IP @).</p> <p>Any pod can communicate with any another pod using its assigned IP address, even if it’s on a different worker node.</p> <p>K8s services are used as virtual IP address, that are discovered via DNS and allow clients to reliably discover and connect to containers.</p> <blockquote> <p>When using <code>nodePort</code> a dynamic published port number is generated by kubernetes.</p> </blockquote> <p>When a pod contains two containers, they run their own <code>cgroup</code>, but shares IPC, Network, and UTC (hostname) namespaces. This can be proven using the following commands:</p> <div class=highlight><pre><span></span><code>oc exec -it my-two-container-pod -c side-car -- /bin/sh
ip address
netstat -ntlp
hostname
</code></pre></div> <h3 id=services>Services<a class=headerlink href=#services title="Permanent link">&para;</a></h3> <ul> <li>A <strong>Service</strong> in Kubernetes is an abstraction which defines a logical set of Pods and a policy by which to access them. <a href=https://kubernetes.io/docs/concepts/services-networking/service/ >Services</a> enable a loose coupling between dependent Pods.</li> <li><strong>Services group</strong> provides network connection to a set of pods for other services in the cluster without exposing the actual private IP address of each pod. </li> </ul> <p>As Pods are ephemeral in nature, resources like IP addresses allocated to it cannot be static. As an example the pods running for the BFF apps are:</p> <div class=highlight><pre><span></span><code>$ kubectl get pods -n greencompute -o wide
NAME                                                  READY     STATUS    RESTARTS   AGE       IP                NODE
gc-caseportal-bc-caseportal-app-698f98d787-56qz5      1/1       Running   0          5d     192.168.130.74   172.16.40.138
gc-caseportal-bc-caseportal-app-698f98d787-bhl5f      1/1       Running   0          5d     192.168.223.17   172.16.40.137
</code></pre></div> <p>The 192.168.x.x is a flat, cluster wide, address space. As illustrated in the figure below:</p> <p><img alt src=../images/pod-proxy-svc.png></p> <p>The command shows the <code>eth0</code> interface in the container is mapped to this IP address.</p> <div class=highlight><pre><span></span><code><span class=w>  </span>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>gc-caseportal-bc-caseportal-app-698f98d787-56qz5<span class=w> </span>--<span class=w> </span>ip<span class=w> </span>addr
<span class=w>  </span>....
<span class=m>4</span>:<span class=w> </span>eth0@if16:<span class=w> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt;<span class=w> </span>mtu<span class=w> </span><span class=m>1500</span><span class=w> </span>qdisc<span class=w> </span>noqueue<span class=w> </span>state<span class=w> </span>UP
<span class=w>    </span>link/ether<span class=w> </span>c2:74:08:4a:69:3f<span class=w> </span>brd<span class=w> </span>ff:ff:ff:ff:ff:ff
<span class=w>    </span>inet<span class=w> </span><span class=m>192</span>.168.130.74/32<span class=w> </span>scope<span class=w> </span>global<span class=w> </span>eth0
</code></pre></div> <p>You can use Kubernetes services to make an app available to other pods inside the cluster or to expose an app to the internet by abstracting the dynamic IP address assignment. The yaml below creates the casewebportal-svc: <code>kubectl apply -f svc.yml</code></p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">casewebportal-svc</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">greencompute</span>
<span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">casewebportal</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<span class=w>  </span><span class=nt>ports</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">6100</span>
<span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">6100</span>
<span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">casewebportal</span>
</code></pre></div> <p>By default, each Service also gets an IP address (known as <strong>ClusterIP</strong>), which is routable only inside the cluster. The target port 6100 is visible as 31560 on the node</p> <div class=highlight><pre><span></span><code>$ kubectl get  svc
NAME                                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
casewebportal-svc                    NodePort    10.10.10.197   &lt;none&gt;        6100:31560/TCP   6d
</code></pre></div> <p>A Service is backed by a group of Pods. These Pods are exposed through endpoints. The command below displays the endpoints. The port number stays the same on all worker nodes and even to the Proxy node.</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>kubectl<span class=w>  </span>get<span class=w> </span>ep<span class=w> </span>casewebportal-svc
NAME<span class=w>                </span>ENDPOINTS<span class=w>                                 </span>AGE
casewebportal-svc<span class=w>   </span><span class=m>192</span>.168.130.74:6100,192.168.223.17:6100<span class=w>   </span>6d
</code></pre></div> <p>When a Pod runs on a Node, the kubelet adds a set of environment variables for each active Service. You can see those variables with the command:</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>gc-caseportal-bc-caseportal-app-698f98d787-56qz5<span class=w> </span>--<span class=w> </span>printenv
</code></pre></div> <p>A Service does the load balancing while selecting the Pods for forwarding the data/traffic. It uses the label and label selector to get access to the pods.</p> <p>Kubernetes offers a <strong>DNS cluster addon</strong> Service that automatically assigns dns names to other Services:</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>services<span class=w> </span>kube-dns<span class=w> </span>--namespace<span class=o>=</span>kube-system
NAME<span class=w>       </span>TYPE<span class=w>        </span>CLUSTER-IP<span class=w>    </span>EXTERNAL-IP<span class=w>   </span>PORT<span class=o>(</span>S<span class=o>)</span><span class=w>         </span>AGE
kube-dns<span class=w>   </span>ClusterIP<span class=w>   </span><span class=m>10</span>.10.10.10<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>53</span>/UDP,53/TCP<span class=w>   </span>10d
</code></pre></div> <p>So we can do a <code>nslookup</code> within any pod to assess where to find the service:</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>gc-caseportal-bc-caseportal-app-698f98d787-56qz5<span class=w> </span>--<span class=w> </span>nslookup<span class=w> </span>casewebportal-svc

nslookup:<span class=w> </span>cant<span class=w> </span>resolve<span class=w> </span><span class=o>(</span>null<span class=o>)</span>:<span class=w> </span>Name<span class=w> </span>does<span class=w> </span>not<span class=w> </span>resolve
Name:<span class=w>      </span>casewebportal-svc
Address<span class=w> </span><span class=m>1</span>:<span class=w> </span><span class=m>10</span>.10.10.197<span class=w> </span>casewebportal-svc.greencompute.svc.cluster.local
</code></pre></div> <p>You can access ClusterIP service using the cluster local proxy:</p> <ul> <li>Start the kubernetes local proxy: <code>kubectl proxy --port=8080</code></li> <li>Access the service via url like: http://localhost:8080/api/v1/proxy/namespaces/NAMESPACE/services/SERVICE-NAME:PORT-NAME/</li> </ul> <p>We can define a service without selectors, so no Endpoint object will be created, and we can map to your own endpoint via the <code>subset.addresses.ip</code> spec. This is useful to abstract other kinds of backend component like DB server, a service in another namespace...</p> <p>The <strong>NodePort</strong> ServiceType is useful when we want to make the services accessible from the external world. BUT if the IP address of the VM changes, you need to take care of this problem in your client code. The end-user connects to the Worker Nodes on the specified port, which forwards the traffic to the applications running inside the cluster. To access the application from the external world, administrators can configure a reverse proxy outside the Kubernetes cluster and map the specific endpoint to the respective port on the Worker Nodes. See <a href=https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0>this article</a></p> <p>Using NGINX server as front end and load balancer, the routing can be done outside the cluster. The following conf file may be deployed in the <code>/etc/nginx/conf.d</code> folder and will help to load balance between two pods:</p> <div class=highlight><pre><span></span><code>upstream caseportal {
  server 172.16.40.137:31560;
  server 172.16.40.138:31560;
}
server {
  location / {
  proxy_pass http://caseportal;
  }
}
</code></pre></div> <p>Alternate is to use <strong>LoadBalancer</strong> service. With the LoadBalancer ServiceType: NodePort and ClusterIP Services are automatically created, and the external load balancer will route to them. The Services are exposed at a static port on each Worker Node. The Service is exposed externally using the underlying Cloud provider's load balancer feature. If you want to directly expose a service, this is the default method. All traffic on the port you specify will be forwarded to the service.</p> <p>Finally,the last model is by using ingress.</p> <h3 id=ingress>Ingress<a class=headerlink href=#ingress title="Permanent link">&para;</a></h3> <p>Ingress is another method (from LoadBalancer and NodePort) we can use to access our applications from the external world. It works at layer 7. The Kubernetes cluster must have an Ingress controller deployed to be able to create Ingress resources. The Ingress controller is deployed as a Docker container. Its Docker image contains a load balancer like NGInx and a controller daemon. The controller daemon receives the desired Ingress configuration from Kubernetes, it generates an NGInx configuration file and restarts the load balancer process for changes to take effect. Ingress controller is a load balancer managed by Kubernetes. Ingress helps to decouple the routing rules from the application, we can then update our application without worrying about its external access. With Ingress, users don't connect directly to a Service. Users reach the Ingress endpoint, and, from there, the request is forwarded to the respective Service. You can define one ingress for all the components of your application you want to expose to external world.</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web-ingress</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>rules</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myservice.mydomain.com</span>
<span class=w>    </span><span class=nt>http</span><span class=p>:</span>
<span class=w>      </span><span class=nt>paths</span><span class=p>:</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/dashboardbff</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>backend</span><span class=p>:</span>
<span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dashboard-bff-svc</span>
<span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">green.myweb.com</span>
<span class=w>    </span><span class=nt>http</span><span class=p>:</span>
<span class=w>      </span><span class=nt>paths</span><span class=p>:</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>backend</span><span class=p>:</span>
<span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">green-service</span>
<span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div> <h3 id=service-discovery>Service Discovery<a class=headerlink href=#service-discovery title="Permanent link">&para;</a></h3> <p>As soon as the Pod starts on any Worker Node, the <strong>kubelet</strong> daemon running on that node adds a set of environment variables in the Pod for all active Services. Be careful while ordering Services definitions, as the Pods will not have the environment variables set for Services which are created after the Pods are created. The DNS add-on, creates a DNS record for each normal Service and the format is like: <code>my-svc.my-namespace.svc.cluster.local</code> within the same namespace can reach to other services with just their name.</p> <p>The following diagram groups all those networking concepts: Ingress, service, kube-proxy and label selectors:</p> <p><img alt src=../images/ingress-svc-proxy.png> </p> <h3 id=kubernetes-dns>Kubernetes DNS<a class=headerlink href=#kubernetes-dns title="Permanent link">&para;</a></h3> <p>Kubelets resolve hostnames for pods through a Service named <code>kube-dns</code>. kube-dns runs as a pod in the kube-system namespace. Every Service that is created is automatically assigned a DNS name. By default, this hostname is <code>ServiceName.Namespace</code>. All Services that are in the same namespace may omit <code>Namespace</code> and just use <code>ServiceName</code>. Here is an example:</p> <p>To understand the default kubernetes DNS pod, you can run</p> <div class=highlight><pre><span></span><code>k describe pod kube-dns-nw8gf -n kube-system
</code></pre></div> <p>It watches the Kubernetes master for changes in Services and Endpoints, and maintains in-memory lookup structures to serve DNS requests. It has a static address, and kubelet passes DNS to each container with the --cluster-dns=<dns-service-ip> flag. The default domain is <code>cluster.local</code>.</p> <h2 id=virtual-private-cloud>Virtual Private Cloud<a class=headerlink href=#virtual-private-cloud title="Permanent link">&para;</a></h2> <p>VPC delivers networking functions for cloud deployments in logically isolated segments using Software Defined Networking.</p> <p>It is a virtual networking platform tied to a tenant account. It provides logical isolation within the same tenant and other tenants. Zones are created using high bandwidth and low latency connections (3 ms). A VPC spans multiple zones at each region for high availability. It does not span regions. With VPC, operators can customize network topologies, sizes, IP addressing without NAT or tunnels. It supports bring your own IP address plan. The security controls are done at the subnet and server level. Some important features:</p> <ul> <li>A region has three or more zones. </li> <li>Multi-zone regions is designed to support enterprise workloads accross application, data, security and solution domains.</li> <li>Availability zone is an independent fault domains that do not share physical infrastructure. It has a latency requirement of &lt;500 micro second intra-zone and &lt;2 ms inter-zone.</li> </ul> <p><a href=../k8s-0/ >&lt;&lt; PREV</a> <a href=../k8s-2/ >&gt;&gt; NEXT</a></p> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "content.tooltips", "navigation.instant", "navigation.expand", "navigation.tabs.sticky", "navigation.top"], "search": "../../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.51d95adb.min.js></script> </body> </html>